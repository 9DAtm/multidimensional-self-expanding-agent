<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>9DA Counterfactual Explorer · Decision Trees</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --deep: #050810;
  --layer: #0e1419;
  --edge: #1a2332;
  --ghost: #2d3748;
  --text: #f7fafc;
  --muted: #94a3b8;
  --path-a: #10b981;
  --path-b: #f59e0b;
  --path-c: #ef4444;
  --decision: #3b82f6;
  --glow: rgba(59, 130, 246, 0.5);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: var(--deep);
  color: var(--text);
  font-family: 'Space Mono', monospace;
  line-height: 1.8;
  overflow-x: hidden;
}

header {
  padding: 4rem 2rem;
  text-align: center;
  background: linear-gradient(180deg, var(--layer) 0%, var(--deep) 100%);
  border-bottom: 2px solid var(--edge);
  position: relative;
}

h1 {
  font-family: 'Playfair Display', serif;
  font-size: 3.5rem;
  font-weight: 700;
  letter-spacing: -0.02em;
  margin-bottom: 1rem;
  background: linear-gradient(135deg, #60a5fa, #a78bfa, #f472b6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.tagline {
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.2em;
  color: var(--muted);
}

main {
  max-width: 1600px;
  margin: 0 auto;
  padding: 3rem 2rem;
}

.explorer-container {
  display: grid;
  grid-template-columns: 350px 1fr;
  gap: 2rem;
  margin-bottom: 2rem;
}

.controls {
  background: var(--layer);
  border: 1px solid var(--edge);
  border-radius: 12px;
  padding: 2rem;
  height: fit-content;
  position: sticky;
  top: 2rem;
}

.controls h2 {
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: var(--muted);
  margin-bottom: 1.5rem;
}

.scenario-selector {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  margin-bottom: 2rem;
}

.scenario-btn {
  background: var(--ghost);
  border: 1px solid var(--edge);
  color: var(--text);
  padding: 1rem;
  border-radius: 8px;
  font-family: 'Space Mono', monospace;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: left;
}

.scenario-btn:hover {
  background: var(--edge);
  border-color: var(--decision);
}

.scenario-btn.active {
  background: var(--decision);
  color: var(--deep);
  font-weight: 700;
}

.metrics {
  display: grid;
  gap: 1rem;
}

.metric {
  background: var(--ghost);
  padding: 1rem;
  border-radius: 8px;
  border-left: 3px solid var(--edge);
}

.metric-label {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--muted);
  margin-bottom: 0.5rem;
}

.metric-value {
  font-size: 1.3rem;
  font-weight: 700;
}

.tree-canvas {
  background: var(--layer);
  border: 1px solid var(--edge);
  border-radius: 12px;
  padding: 2rem;
  min-height: 800px;
  position: relative;
}

canvas {
  width: 100%;
  height: 100%;
}

.analysis {
  background: var(--layer);
  border: 1px solid var(--edge);
  border-radius: 12px;
  padding: 2rem;
  margin-top: 2rem;
}

.analysis h2 {
  font-family: 'Playfair Display', serif;
  font-size: 1.8rem;
  margin-bottom: 1.5rem;
}

.analysis-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1.5rem;
  margin-top: 1.5rem;
}

.path-card {
  background: var(--ghost);
  border: 1px solid var(--edge);
  border-radius: 8px;
  padding: 1.5rem;
  transition: transform 0.3s ease;
}

.path-card:hover {
  transform: translateY(-4px);
}

.path-card.green { border-left: 4px solid var(--path-a); }
.path-card.amber { border-left: 4px solid var(--path-b); }
.path-card.red { border-left: 4px solid var(--path-c); }

.path-title {
  font-weight: 700;
  margin-bottom: 0.5rem;
  font-size: 1.1rem;
}

.path-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.75rem;
  margin-top: 1rem;
  font-size: 0.8rem;
}

.path-stat {
  display: flex;
  justify-content: space-between;
}

.path-stat-label {
  color: var(--muted);
}

.path-stat-value {
  font-weight: 700;
}

.warning {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid var(--path-c);
  padding: 1rem;
  border-radius: 8px;
  margin-top: 1rem;
  font-size: 0.85rem;
}

.tooltip {
  position: absolute;
  background: var(--deep);
  border: 1px solid var(--edge);
  padding: 1rem;
  border-radius: 8px;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s ease;
  z-index: 100;
  max-width: 250px;
  font-size: 0.8rem;
}

.tooltip.show {
  opacity: 1;
}
</style>
</head>
<body>

<header>
  <h1>Counterfactual Explorer</h1>
  <div class="tagline">Alternative Decision Paths · Governed Autonomy</div>
</header>

<main>
  <div class="explorer-container">
    <div class="controls">
      <h2>Decision Scenarios</h2>
      <div class="scenario-selector">
        <button class="scenario-btn active" onclick="loadScenario(0)">
          <div style="font-weight: 700;">High Uncertainty Context</div>
          <div style="font-size: 0.75rem; color: var(--muted); margin-top: 0.25rem;">U: 0.72 | C: 0.48</div>
        </button>
        <button class="scenario-btn" onclick="loadScenario(1)">
          <div style="font-weight: 700;">Stable Coherent State</div>
          <div style="font-size: 0.75rem; color: var(--muted); margin-top: 0.25rem;">U: 0.25 | C: 0.85</div>
        </button>
        <button class="scenario-btn" onclick="loadScenario(2)">
          <div style="font-weight: 700;">Critical Threshold</div>
          <div style="font-size: 0.75rem; color: var(--muted); margin-top: 0.25rem;">U: 0.84 | C: 0.18</div>
        </button>
      </div>

      <h2 style="margin-top: 2rem;">Initial State</h2>
      <div class="metrics">
        <div class="metric">
          <div class="metric-label">Coherence</div>
          <div class="metric-value" id="coherence">0.48</div>
        </div>
        <div class="metric">
          <div class="metric-label">Uncertainty</div>
          <div class="metric-value" id="uncertainty">0.72</div>
        </div>
        <div class="metric">
          <div class="metric-label">Risk</div>
          <div class="metric-value" id="risk">0.37</div>
        </div>
        <div class="metric">
          <div class="metric-label">Stability</div>
          <div class="metric-value" id="stability">0.14</div>
        </div>
      </div>
    </div>

    <div class="tree-canvas">
      <canvas id="decision-tree"></canvas>
    </div>
  </div>

  <div class="analysis">
    <h2>Counterfactual Analysis</h2>
    <div class="analysis-grid" id="analysis-grid"></div>
  </div>
</main>

<div class="tooltip" id="tooltip"></div>

<script>
const canvas = document.getElementById('decision-tree');
const ctx = canvas.getContext('2d');
const tooltip = document.getElementById('tooltip');

let currentScenario = 0;

const scenarios = [
  {
    name: "High Uncertainty Context",
    coherence: 0.48,
    uncertainty: 0.72,
    risk: 0.37,
    stability: 0.14
  },
  {
    name: "Stable Coherent State",
    coherence: 0.85,
    uncertainty: 0.25,
    risk: 0.13,
    stability: 0.64
  },
  {
    name: "Critical Threshold",
    coherence: 0.18,
    uncertainty: 0.84,
    risk: 0.69,
    stability: 0.03
  }
];

function resizeCanvas() {
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * window.devicePixelRatio;
  canvas.height = 800 * window.devicePixelRatio;
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
  drawTree();
}

window.addEventListener('resize', resizeCanvas);

function loadScenario(index) {
  currentScenario = index;
  
  const buttons = document.querySelectorAll('.scenario-btn');
  buttons.forEach((btn, i) => {
    btn.classList.toggle('active', i === index);
  });
  
  const scenario = scenarios[index];
  document.getElementById('coherence').textContent = scenario.coherence.toFixed(2);
  document.getElementById('uncertainty').textContent = scenario.uncertainty.toFixed(2);
  document.getElementById('risk').textContent = scenario.risk.toFixed(2);
  document.getElementById('stability').textContent = scenario.stability.toFixed(2);
  
  drawTree();
  updateAnalysis();
}

function generateCounterfactuals(scenario) {
  const base = scenario;
  
  return [
    {
      name: "Increase Coherence",
      type: "intervention",
      coherence: Math.min(1.0, base.coherence + 0.25),
      uncertainty: base.uncertainty,
      risk: base.risk * 0.7,
      stability: Math.min(1.0, base.stability + 0.2),
      outcome: "Improved alignment and reduced risk",
      violates_invariant: false
    },
    {
      name: "Reduce Uncertainty",
      type: "intervention",
      coherence: base.coherence,
      uncertainty: Math.max(0.0, base.uncertainty - 0.25),
      risk: base.risk * 0.6,
      stability: Math.min(1.0, base.stability + 0.15),
      outcome: "Enhanced predictability",
      violates_invariant: false
    },
    {
      name: "Natural Drift (Positive)",
      type: "drift",
      coherence: Math.min(1.0, base.coherence + 0.1),
      uncertainty: Math.max(0.0, base.uncertainty - 0.05),
      risk: base.risk * 0.9,
      stability: Math.min(1.0, base.stability + 0.05),
      outcome: "Gradual improvement",
      violates_invariant: false
    },
    {
      name: "Natural Drift (Negative)",
      type: "drift",
      coherence: Math.max(0.0, base.coherence - 0.15),
      uncertainty: Math.min(1.0, base.uncertainty + 0.1),
      risk: Math.min(1.0, base.risk * 1.4),
      stability: Math.max(0.0, base.stability - 0.1),
      outcome: "Degradation without intervention",
      violates_invariant: base.coherence - 0.15 < 0.15 || base.uncertainty + 0.1 > 0.85
    },
    {
      name: "Coherence Collapse",
      type: "failure",
      coherence: Math.max(0.0, base.coherence - 0.4),
      uncertainty: Math.min(1.0, base.uncertainty + 0.3),
      risk: Math.min(1.0, base.risk + 0.5),
      stability: Math.max(0.0, base.stability - 0.3),
      outcome: "Critical failure state",
      violates_invariant: true
    },
    {
      name: "Maintain Current",
      type: "baseline",
      coherence: base.coherence,
      uncertainty: base.uncertainty,
      risk: base.risk,
      stability: base.stability,
      outcome: "No change",
      violates_invariant: base.coherence < 0.15 || base.uncertainty > 0.85
    }
  ];
}

function drawTree() {
  const rect = canvas.getBoundingClientRect();
  ctx.clearRect(0, 0, rect.width, 800);
  
  const scenario = scenarios[currentScenario];
  const paths = generateCounterfactuals(scenario);
  
  const centerX = rect.width / 2;
  const startY = 100;
  const branchSpacing = rect.width / (paths.length + 1);
  
  // Draw connections first
  ctx.strokeStyle = 'rgba(45, 55, 72, 0.5)';
  ctx.lineWidth = 2;
  
  paths.forEach((path, i) => {
    const targetX = branchSpacing * (i + 1);
    const targetY = 400;
    
    ctx.beginPath();
    ctx.moveTo(centerX, startY + 40);
    
    // Curved path
    const controlY = (startY + targetY) / 2;
    ctx.bezierCurveTo(
      centerX, controlY,
      targetX, controlY,
      targetX, targetY - 40
    );
    
    // Color based on outcome
    if (path.violates_invariant) {
      ctx.strokeStyle = 'rgba(239, 68, 68, 0.6)';
    } else if (path.type === 'intervention') {
      ctx.strokeStyle = 'rgba(16, 185, 129, 0.6)';
    } else if (path.type === 'drift') {
      ctx.strokeStyle = 'rgba(245, 158, 11, 0.6)';
    } else {
      ctx.strokeStyle = 'rgba(148, 163, 184, 0.4)';
    }
    ctx.lineWidth = path.violates_invariant ? 3 : 2;
    ctx.stroke();
  });
  
  // Draw root node
  drawNode(ctx, centerX, startY, 'Current State', scenario, '#3b82f6', true);
  
  // Draw outcome nodes
  paths.forEach((path, i) => {
    const x = branchSpacing * (i + 1);
    const y = 400;
    
    let color;
    if (path.violates_invariant) color = '#ef4444';
    else if (path.type === 'intervention') color = '#10b981';
    else if (path.type === 'drift') color = '#f59e0b';
    else color = '#64748b';
    
    drawNode(ctx, x, y, path.name, path, color, false);
  });
}

function drawNode(ctx, x, y, label, data, color, isRoot) {
  const size = isRoot ? 50 : 40;
  
  // Glow
  ctx.beginPath();
  ctx.arc(x, y, size + 8, 0, Math.PI * 2);
  ctx.fillStyle = color + '40';
  ctx.fill();
  
  // Main circle
  ctx.beginPath();
  ctx.arc(x, y, size, 0, Math.PI * 2);
  ctx.fillStyle = '#0e1419';
  ctx.fill();
  ctx.strokeStyle = color;
  ctx.lineWidth = 3;
  ctx.stroke();
  
  // Inner coherence ring
  ctx.beginPath();
  ctx.arc(x, y, size * 0.7 * data.coherence, 0, Math.PI * 2);
  ctx.fillStyle = color + '60';
  ctx.fill();
  
  // Label
  ctx.fillStyle = '#f7fafc';
  ctx.font = isRoot ? 'bold 13px Space Mono' : '11px Space Mono';
  ctx.textAlign = 'center';
  ctx.fillText(label, x, y + size + 25);
  
  // Stats
  if (!isRoot) {
    ctx.font = '9px Space Mono';
    ctx.fillStyle = '#94a3b8';
    ctx.fillText(`C: ${data.coherence.toFixed(2)}`, x, y + size + 40);
    ctx.fillText(`U: ${data.uncertainty.toFixed(2)}`, x, y + size + 53);
  }
}

function updateAnalysis() {
  const scenario = scenarios[currentScenario];
  const paths = generateCounterfactuals(scenario);
  
  const grid = document.getElementById('analysis-grid');
  grid.innerHTML = '';
  
  paths.forEach(path => {
    const card = document.createElement('div');
    card.className = 'path-card';
    
    if (path.violates_invariant) {
      card.classList.add('red');
    } else if (path.type === 'intervention') {
      card.classList.add('green');
    } else if (path.type === 'drift') {
      card.classList.add('amber');
    }
    
    let warningHtml = '';
    if (path.violates_invariant) {
      warningHtml = `
        <div class="warning">
          ⚠ Violates invariant constraints
        </div>
      `;
    }
    
    card.innerHTML = `
      <div class="path-title">${path.name}</div>
      <div style="color: var(--muted); font-size: 0.85rem; margin-top: 0.25rem;">
        ${path.outcome}
      </div>
      <div class="path-stats">
        <div class="path-stat">
          <span class="path-stat-label">Coherence</span>
          <span class="path-stat-value">${path.coherence.toFixed(2)}</span>
        </div>
        <div class="path-stat">
          <span class="path-stat-label">Uncertainty</span>
          <span class="path-stat-value">${path.uncertainty.toFixed(2)}</span>
        </div>
        <div class="path-stat">
          <span class="path-stat-label">Risk</span>
          <span class="path-stat-value">${path.risk.toFixed(2)}</span>
        </div>
        <div class="path-stat">
          <span class="path-stat-label">Stability</span>
          <span class="path-stat-value">${path.stability.toFixed(2)}</span>
        </div>
      </div>
      ${warningHtml}
    `;
    
    grid.appendChild(card);
  });
}

// Initialize
resizeCanvas();
loadScenario(0);
</script>

</body>
</html>
